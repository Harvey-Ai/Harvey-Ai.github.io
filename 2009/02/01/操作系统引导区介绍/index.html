<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Hello"><title>操作系统引导区介绍 | Wei's Words</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">操作系统引导区介绍</h1><a id="logo" href="/.">Wei's Words</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4-4"><div class="content_container"><div class="post"><h1 class="post-title">操作系统引导区介绍</h1><div class="post-meta">2009-02-01<span> | </span><span class="category"><a href="/categories/System/">System</a></span></div><div class="post-content"><p>硬盘的0柱面、0磁头、1扇区称为主引导扇区，FDISK程序写到该扇区的内容称为主引导记录（MBR）。该记录占用512个字节，它用于硬盘启动时将系统控制权交给用户指定的，并在分区表中登记了的某个操作系统区。</p>
<p>硬盘的引导记录（MBR）是不属于任何一个操作系统，也不能用操作系统提供的磁盘操作命令来读取它，在windows下可以使用WinHex查看和修改,linux下用dd吧。硬盘的0磁道0柱面1扇区包括硬盘主引导记录 MBR（Main Boot Record）和分区表DPT（Disk Partition Table）。其中主引导记录的作用就是检查分区表是否正确以及确定哪个分区为引导分区，并在程序结束时把该分区的启动程序（也就是操作系统引导扇区）调入内存加以执行。</p>
<p>主引导扇区释疑</p>
<p>关键词：引导扇区、主引导扇区、主引导记录、硬盘分区表。</p>
<p>引导扇区在每个分区里都存在，但是我们常说的<em>主引导扇区</em>是硬盘的第一物理扇区。它由两个部分组成：即主引导记录MBR和硬盘分区表DPT。在总共512 字节的主引导分区里其中MBR占446个字节（偏移 0–偏移1BDH)，DPT占64个字节（偏移1BEH–偏移1FDH),最后两个字节 “55，AA”（偏移1FEH)是分区的结束标志。大致的结构如下图：<br>0000 |————————————————|<br>| |<br>| | |Main Boot Record |<br>| |<br>| | |主引导记录(446字节) |<br>| |<br>01BD | |<br>01BE |————————————————|<br>| |<br>01CD | 分区信息 1(16字节) |<br>01CE |————————————————|<br>| |<br>01DD | 分区信息 2(16字节) |<br>01DE |————————————————|<br>| |<br>01ED | 分区信息 3(16字节) |<br>01EE |————————————————|<br>| |</p>
<p>01FD | 分区信息 4(16字节) |（这里可以看到，主分区个数最多是4个）<br>|————————————————|<br>| 01FE | 01FF |(错误信息）</p>
<p>| 55 | AA |<br>|————————————————|</p>
<p>主引导记录中包含了硬盘的一系列参数和一段引导程序。引导程序主要是用来在系统硬件自检完后引导具有激活标志的分区上的操作系统。它执行到最后的是一条JMP指令跳到操作系统的引导程序去。这里往往是引导型病毒的注入点，也是各种多系统引导程序的注入点。但是由于引导程序本身完成的功能比较简单，所以我们可以完全地判断该引导程序的合法性 （看JMP指令的合法性），因而也易于修复。象命令 fdisk&#x2F;mbr可以修复MBR和KV300这类软件可以查杀任意类型的引导型病毒，就是这个原因。</p>
<p>往下来是硬盘的分区表，由4个16字节的分区信息表组成。</p>
<p><a target="_blank" rel="noopener" href="http://115.28.13.176/blog/wp-content/uploads/2009/02/bootFan.png"><img src="http://115.28.13.176/blog/wp-content/uploads/2009/02/bootFan-300x204.png" alt="bootFan"></a></p>
<p>最后的两个标志“55 AA”是分区表的结束标志，如果这两个标志被修改（有些病毒就会修改这两个标志），则系统引导时将报告找不到有效的分区表。</p>
<p>所以整个MBR是这样组成的：MBR+DPT+MagicNumber(446+64+2&#x3D;512)</p>
<p>下面简单介绍一下系统启动的引导步骤，系统启动过程主要由一下几步组成(以硬盘启动为例):<br>1. 开机 :-)<br>2. BIOS 加电自检( Power On Self Test – POST )，内存地址为 0ffff:0000<br>3. 将硬盘第一个扇区(0头0道 1扇区, 也就是Boot Sector)，读入内存地址 0000:7c00 处。<br>4. 检查 (WORD) 0000:7dfe 是否等于0xaa55, 若不等于则转去尝试其他启动介质, 如果没有其他启动介质则显示”No ROM BASIC” 然后死机.<br>5. 跳转到 0000:7c00 处执行 MBR 中的程序.<br>6. MBR首先将自己复制到 0000:0600 处, 然后继续执行.<br>7. 在主分区表中搜索标志为活动的分区。如果发现没有活动分区或有不止一个活动分区, 则转停止.<br>8. 将活动分区的第一个扇区读入内存地址 0000:7c00 处.<br>9. 检查 (WORD) 0000:7dfe 是否等于 0xaa55, 若不等于则显示 “Missing Operating System” 然后停止, 或尝试软盘启动.<br>10. 跳转到 0000:7c00 处继续执行特定系统的启动程序.<br>11. 启动系统 …</p>
<p>是不是有点冲动。。，从网上摘抄一段引导程序，看样子是没什么问题，但是这个不是轻易就可以试的，改过MBR后，怎么改回来？</p>
<p>写入MBR的引导程序：<br>entry start<br>start:<br>mov ax,#0xb800<br>mov es,ax<br>seg es<br>mov [0],#0x41<br>seg es<br>mov [1],#0x1f<br>loop1: jmp loop1</p>
<p>再来一个C语言的写MBR程序<br>#include &#x2F;* unistd.h 需要这个文件 <em>&#x2F;<br>#include &#x2F;</em> 包含有read和write函数 *&#x2F;<br>#include<br>int main()<br>{<br>char boot_buf[512];<br>int floppy_desc, file_desc;<br>file_desc &#x3D; open(“.&#x2F;boot”, O_RDONLY);<br>read(file_desc, boot_buf, 510);<br>close(file_desc);<br>boot_buf[510] &#x3D; 0x55;<br>boot_buf[511] &#x3D; 0xaa;<br>floppy_desc &#x3D; open(“&#x2F;dev&#x2F;fd0”, O_RDWR);<br>lseek(floppy_desc, 0, SEEK_CUR);<br>write(floppy_desc, boot_buf, 512);<br>close(floppy_desc);<br>}</p>
<p>用软盘启动系统,系统成功引导后应该会出现’A’字符。</p>
<p>笔者用winhex 查看了MBR的内容，从这部分内容可以看到，笔者的MBR里面是GRUB的引导程序，最后位置0X01FE上确实是55AA。</p>
<p>附图：</p>
<p><a target="_blank" rel="noopener" href="http://115.28.13.176/blog/wp-content/uploads/2009/02/bootFan2.jpg"><img src="http://115.28.13.176/blog/wp-content/uploads/2009/02/bootFan2-300x162.jpg" alt="bootFan2"></a></p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BC%95%E5%AF%BC%E6%89%87%E5%8C%BA/" rel="tag">引导扇区</a></li></ul></div><div class="post-nav"><a class="pre" href="/2009/02/06/%E6%98%A5%E8%8A%82%E5%B0%8F%E8%AE%B0/">春节小记</a><a class="next" href="/2009/01/15/%E5%8E%86%E5%B1%8A%E5%BD%93%E9%80%89ACM%20Fellow%E7%9A%84%E5%A4%A7%E9%99%86%E5%AD%A6%E5%AD%90%E7%BB%9F%E8%AE%A1/">历届当选ACM Fellow的大陆学子统计</a></div></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer">Copyright © 2023 <a href="/." rel="nofollow">Wei's Words.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>